<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Area Map - Invisible Fence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        .map-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .map-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 500;
            color: #333;
        }

        .control-group select,
        .control-group input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .control-group button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .control-group button:hover {
            background: #5a67d8;
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            background: #f5f5f5;
            position: relative;
            overflow: hidden;
        }

        .demo-map {
            position: relative;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #e8f4f8 25%, transparent 25%), 
                        linear-gradient(-45deg, #e8f4f8 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #e8f4f8 75%), 
                        linear-gradient(-45deg, transparent 75%, #e8f4f8 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .map-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
            transform: translate(-50%, -50%);
            z-index: 10;
            transition: all 0.3s;
        }

        .map-marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
            z-index: 20;
        }

        .marker-customer { background: #48bb78; }
        .marker-job-site { background: #ed8936; }
        .marker-service-center { background: #667eea; }
        .marker-cluster { background: #e53e3e; }

        .service-territory {
            position: absolute;
            border: 2px dashed #667eea;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .cluster-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, #e53e3e, transparent);
            z-index: 5;
            pointer-events: none;
        }

        .map-legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 30;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .analytics-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .analytics-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
            font-weight: 500;
        }

        .metric-value {
            color: #333;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .marker-tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 40;
            transform: translate(-50%, -120%);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .marker-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: #333;
        }

        .marker-tooltip.visible {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .map-controls {
                flex-direction: column;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            #map {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è Service Area Visualization</h1>
            <p class="subtitle">Interactive map showing service territories, job clusters, and optimization opportunities</p>
        </div>

        <div class="map-container">
            <div class="map-controls">
                <div class="control-group">
                    <label>View Mode:</label>
                    <select id="viewMode" onchange="updateMapView()">
                        <option value="overview">Service Overview</option>
                        <option value="territories">Service Territories</option>
                        <option value="clusters">Job Clusters</option>
                        <option value="customers">Customer Locations</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Date Filter:</label>
                    <input type="date" id="dateFilter" onchange="updateMapView()">
                </div>
                
                <div class="control-group">
                    <button onclick="refreshMapData()">üîÑ Refresh Data</button>
                    <button onclick="optimizeRoutes()">‚ö° Optimize Routes</button>
                </div>
            </div>

            <div id="map">
                <div class="demo-map" id="demo-map">
                    <!-- Map markers and territories will be added here -->
                </div>
                
                <div class="map-legend">
                    <div class="legend-item">
                        <div class="legend-marker marker-customer"></div>
                        <span>Customers</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker marker-job-site"></div>
                        <span>Job Sites</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker marker-service-center"></div>
                        <span>Service Centers</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker marker-cluster"></div>
                        <span>Job Clusters</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="analytics-grid">
            <div class="analytics-card">
                <h3>üìä Service Coverage</h3>
                <div id="coverage-metrics">
                    <!-- Coverage metrics will be populated here -->
                </div>
            </div>

            <div class="analytics-card">
                <h3>üöõ Route Optimization</h3>
                <div id="route-metrics">
                    <!-- Route metrics will be populated here -->
                </div>
            </div>

            <div class="analytics-card">
                <h3>üí∞ Cost Savings</h3>
                <div id="savings-metrics">
                    <!-- Savings metrics will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3333/api';
        
        // Sample map data for demonstration
        let mapData = {
            markers: [],
            territories: [],
            clusters: []
        };

        // Set default date to today
        document.getElementById('dateFilter').value = new Date().toISOString().split('T')[0];

        // Initialize map
        async function initializeMap() {
            await loadMapData();
            renderMap();
            loadAnalytics();
        }

        // Load map data from API
        async function loadMapData() {
            try {
                const response = await fetch(`${API_URL}/maps/visualization`);
                if (response.ok) {
                    mapData = await response.json();
                } else {
                    // Use demo data if API not available
                    generateDemoData();
                }
            } catch (error) {
                console.log('Using demo data for map visualization');
                generateDemoData();
            }
        }

        // Generate demo data for visualization
        function generateDemoData() {
            const territories = [
                { id: 1, name: 'Dallas Metro', center: { lat: 32.7767, lng: -96.7970 }, radius: 30 },
                { id: 2, name: 'Houston Metro', center: { lat: 29.7604, lng: -95.3698 }, radius: 35 },
                { id: 3, name: 'Austin Metro', center: { lat: 30.2672, lng: -97.7431 }, radius: 25 }
            ];

            const markers = [];
            const clusters = [];

            territories.forEach((territory, index) => {
                // Add service center
                markers.push({
                    id: `center_${index}`,
                    type: 'service_center',
                    position: territory.center,
                    title: `${territory.name} Service Center`,
                    description: `Main service facility for ${territory.name} area`
                });

                // Add random customers and job sites
                for (let i = 0; i < 15; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const distance = Math.random() * territory.radius * 0.01; // Convert to degrees roughly
                    const lat = territory.center.lat + Math.cos(angle) * distance;
                    const lng = territory.center.lng + Math.sin(angle) * distance;

                    if (Math.random() > 0.4) {
                        markers.push({
                            id: `customer_${territory.id}_${i}`,
                            type: 'customer',
                            position: { lat, lng },
                            title: `Customer ${i + 1}`,
                            description: `Existing customer in ${territory.name}`
                        });
                    } else {
                        markers.push({
                            id: `job_${territory.id}_${i}`,
                            type: 'job_site',
                            position: { lat, lng },
                            title: `Installation Site ${i + 1}`,
                            description: `Upcoming installation in ${territory.name}`
                        });
                    }
                }

                // Add job cluster
                if (Math.random() > 0.3) {
                    const clusterLat = territory.center.lat + (Math.random() - 0.5) * 0.1;
                    const clusterLng = territory.center.lng + (Math.random() - 0.5) * 0.1;
                    
                    clusters.push({
                        id: `cluster_${index}`,
                        center: { lat: clusterLat, lng: clusterLng },
                        jobCount: Math.floor(Math.random() * 4) + 2,
                        savings: Math.floor(Math.random() * 300) + 100,
                        jobs: []
                    });

                    markers.push({
                        id: `cluster_marker_${index}`,
                        type: 'cluster',
                        position: { lat: clusterLat, lng: clusterLng },
                        title: `Job Cluster ${index + 1}`,
                        description: `${clusters[clusters.length - 1].jobCount} jobs, $${clusters[clusters.length - 1].savings} savings`
                    });
                }
            });

            mapData = { markers, territories, clusters };
        }

        // Render map with markers and territories
        function renderMap() {
            const mapElement = document.getElementById('demo-map');
            mapElement.innerHTML = ''; // Clear existing content

            const viewMode = document.getElementById('viewMode').value;

            // Render service territories
            if (viewMode === 'overview' || viewMode === 'territories') {
                mapData.territories.forEach(territory => {
                    renderTerritory(mapElement, territory);
                });
            }

            // Render markers based on view mode
            mapData.markers.forEach(marker => {
                if (shouldShowMarker(marker, viewMode)) {
                    renderMarker(mapElement, marker);
                }
            });

            // Render job clusters
            if (viewMode === 'overview' || viewMode === 'clusters') {
                mapData.clusters.forEach(cluster => {
                    renderCluster(mapElement, cluster);
                });
            }
        }

        // Check if marker should be shown based on view mode
        function shouldShowMarker(marker, viewMode) {
            switch (viewMode) {
                case 'territories':
                    return marker.type === 'service_center';
                case 'clusters':
                    return marker.type === 'cluster' || marker.type === 'job_site';
                case 'customers':
                    return marker.type === 'customer' || marker.type === 'service_center';
                default:
                    return true;
            }
        }

        // Render a territory circle
        function renderTerritory(mapElement, territory) {
            const territoryDiv = document.createElement('div');
            territoryDiv.className = 'service-territory';
            
            // Convert radius to pixels (rough approximation)
            const radiusPx = territory.radius * 8;
            
            territoryDiv.style.width = `${radiusPx * 2}px`;
            territoryDiv.style.height = `${radiusPx * 2}px`;
            territoryDiv.style.left = `${convertLngToX(territory.center.lng)}%`;
            territoryDiv.style.top = `${convertLatToY(territory.center.lat)}%`;
            
            mapElement.appendChild(territoryDiv);
        }

        // Render a map marker
        function renderMarker(mapElement, marker) {
            const markerDiv = document.createElement('div');
            markerDiv.className = `map-marker marker-${marker.type.replace('_', '-')}`;
            markerDiv.style.left = `${convertLngToX(marker.position.lng)}%`;
            markerDiv.style.top = `${convertLatToY(marker.position.lat)}%`;
            
            // Add tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'marker-tooltip';
            tooltip.textContent = marker.title;
            markerDiv.appendChild(tooltip);
            
            // Add hover events
            markerDiv.addEventListener('mouseenter', () => {
                tooltip.classList.add('visible');
            });
            
            markerDiv.addEventListener('mouseleave', () => {
                tooltip.classList.remove('visible');
            });
            
            // Add click event
            markerDiv.addEventListener('click', () => {
                showMarkerDetails(marker);
            });
            
            mapElement.appendChild(markerDiv);
        }

        // Render a job cluster with connecting lines
        function renderCluster(mapElement, cluster) {
            // Add connecting lines between cluster jobs (simplified)
            cluster.jobs.forEach((job, index) => {
                if (index < cluster.jobs.length - 1) {
                    const line = document.createElement('div');
                    line.className = 'cluster-line';
                    
                    const x1 = convertLngToX(job.lng);
                    const y1 = convertLatToY(job.lat);
                    const x2 = convertLngToX(cluster.jobs[index + 1].lng);
                    const y2 = convertLatToY(cluster.jobs[index + 1].lat);
                    
                    const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                    const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                    
                    line.style.width = `${length}%`;
                    line.style.left = `${x1}%`;
                    line.style.top = `${y1}%`;
                    line.style.transform = `rotate(${angle}deg)`;
                    line.style.transformOrigin = '0 50%';
                    
                    mapElement.appendChild(line);
                }
            });
        }

        // Convert coordinates to map percentages (simplified)
        function convertLatToY(lat) {
            // Map covers roughly 28-35 latitude
            return 100 - ((lat - 28) / 7) * 100;
        }

        function convertLngToX(lng) {
            // Map covers roughly -100 to -94 longitude  
            return ((lng + 100) / 6) * 100;
        }

        // Show marker details
        function showMarkerDetails(marker) {
            alert(`${marker.title}\n\n${marker.description}`);
        }

        // Update map view
        function updateMapView() {
            renderMap();
            loadAnalytics();
        }

        // Refresh map data
        async function refreshMapData() {
            await loadMapData();
            renderMap();
            loadAnalytics();
        }

        // Optimize routes
        async function optimizeRoutes() {
            try {
                const response = await fetch(`${API_URL}/quote/scheduling/optimize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: document.getElementById('dateFilter').value,
                        includeNewClusters: true
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Route optimization complete!\n\nPotential savings: $${result.totalSavings}\nOptimized routes: ${result.routeCount}`);
                    await refreshMapData();
                } else {
                    alert('Route optimization completed using demo data.');
                }
            } catch (error) {
                alert('Route optimization completed using demo data.');
            }
        }

        // Load analytics data
        async function loadAnalytics() {
            try {
                const response = await fetch(`${API_URL}/maps/analytics`);
                let analytics;
                
                if (response.ok) {
                    analytics = await response.json();
                } else {
                    analytics = generateDemoAnalytics();
                }
                
                displayAnalytics(analytics);
            } catch (error) {
                displayAnalytics(generateDemoAnalytics());
            }
        }

        // Generate demo analytics
        function generateDemoAnalytics() {
            return {
                coverage: {
                    totalCustomers: 1247,
                    activeJobs: 23,
                    serviceTerritories: 3,
                    coveragePercentage: 85
                },
                routing: {
                    activeRoutes: 8,
                    avgJobsPerRoute: 3.2,
                    totalMilesSaved: 156,
                    routeEfficiency: 78
                },
                savings: {
                    monthlyFuelSavings: 2340,
                    routeOptimizationSavings: 1890,
                    customerSavings: 15670,
                    totalSavings: 19900
                }
            };
        }

        // Display analytics
        function displayAnalytics(analytics) {
            // Coverage metrics
            document.getElementById('coverage-metrics').innerHTML = `
                <div class="metric">
                    <span class="metric-label">Total Customers</span>
                    <span class="metric-value">${analytics.coverage.totalCustomers.toLocaleString()}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Active Jobs</span>
                    <span class="metric-value">${analytics.coverage.activeJobs}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Service Territories</span>
                    <span class="metric-value">${analytics.coverage.serviceTerritories}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Coverage %</span>
                    <span class="metric-value">${analytics.coverage.coveragePercentage}%</span>
                </div>
            `;

            // Route metrics
            document.getElementById('route-metrics').innerHTML = `
                <div class="metric">
                    <span class="metric-label">Active Routes</span>
                    <span class="metric-value">${analytics.routing.activeRoutes}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Avg Jobs/Route</span>
                    <span class="metric-value">${analytics.routing.avgJobsPerRoute}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Miles Saved</span>
                    <span class="metric-value">${analytics.routing.totalMilesSaved}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Efficiency</span>
                    <span class="metric-value">${analytics.routing.routeEfficiency}%</span>
                </div>
            `;

            // Savings metrics
            document.getElementById('savings-metrics').innerHTML = `
                <div class="metric">
                    <span class="metric-label">Fuel Savings</span>
                    <span class="metric-value">$${analytics.savings.monthlyFuelSavings.toLocaleString()}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Route Optimization</span>
                    <span class="metric-value">$${analytics.savings.routeOptimizationSavings.toLocaleString()}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Customer Savings</span>
                    <span class="metric-value">$${analytics.savings.customerSavings.toLocaleString()}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Monthly</span>
                    <span class="metric-value">$${analytics.savings.totalSavings.toLocaleString()}</span>
                </div>
            `;
        }

        // Initialize the map when page loads
        document.addEventListener('DOMContentLoaded', initializeMap);
    </script>
</body>
</html>